# 商業施設リノベーション機能 実装ドキュメント

## 📋 実装完了状況

### ✅ Phase 1: インフラ構築（完了）

**環境変数による機能フラグ**
- `.env.development`: `VITE_ENABLE_COMMERCIAL_MODE=true`（開発環境のみ有効）
- `.env.production`: `VITE_ENABLE_COMMERCIAL_MODE=false`（本番環境では無効）
- `src/config/featureFlags.ts`: 機能フラグ管理システム

**型定義の追加**
- `types.ts`: 商業施設関連の型を追加（L328-422）
  - `RenovationSubMode`: 'residential' | 'commercial'
  - `FacilityType`: 8種類の施設タイプ
  - `OriginalSpaceType`: 5種類の元空間タイプ
  - `CommercialStep`: 4段階のワークフロー
  - `CommercialRenovationContext`: コンテキスト管理

**定数定義**
- `constants.ts`: 商業施設関連の定数を追加（L699-991）
  - `FACILITY_TYPES`: 8種類の施設タイプ
  - `ORIGINAL_SPACE_TYPES`: 5種類の元空間タイプ
  - `COMMERCIAL_STEPS`: 4段階のステップ定義
  - `FACILITY_ADJUSTMENT_ITEMS`: 各施設タイプ専用の調整項目

---

### ✅ Phase 2: UI実装（完了）

**App.tsx の変更**
- L35: featureFlagsのインポート
- L86-105: commercialContext状態の追加（useLocalStorageで永続化）
- L1575-1580, L1714-1719: RenovationPanelへのprops追加（条件付き）

**RenovationPanel.tsx の実装**
- L4: FACILITY_ADJUSTMENT_ITEMSのインポート追加
- L16-20: Props interfaceに商業施設モード用のpropsを追加
- L2213-2656: `renderCommercialModeUI()`関数の実装
  - フェーズ自動判定ロジック（generationCountベース）
  - 施設タイプ・元空間選択UI
  - コンセプトキーワード入力
  - ゾーニング設定（エリア・動線パターン）
  - 詳細デザイン（カラースキーム・素材）
  - 仕上げ（追加指示）
  - 動的な生成ボタン（フェーズ別ラベル）

---

### ✅ Phase 3: 画像生成エンジン統合（完了）

**geminiService.ts の実装**
- L3: 型インポートの追加（CommercialRenovationContext等）
- L815-992: `generateCommercialRenovationImage`関数の実装
  - 累積的なプロンプト構築システム
  - フェーズ別のプロンプト生成ロジック
  - 施設タイプ・元空間タイプの日本語名変換
  - promptHistoryを活用した一貫性維持

**App.tsx の画像生成統合**
- L26: generateCommercialRenovationImageのインポート
- L640-643: 商業施設モード用の画像生成処理
- L668-691: 画像生成成功時の処理
  - generationCountの自動インクリメント
  - フェーズの自動切り替え（0-2:定義, 3-5:ゾーニング, 6-8:デザイン, 9+:仕上げ）
  - promptHistoryへの自動保存
  - lastGeneratedImageUrlの更新
- L702: 依存配列にcommercialContext追加

---

### ✅ Phase 4: バグ修正（完了）

**HelpTooltip.tsx の修正**
- L13: `useRef<HTMLButtonElement>`→`useRef<HTMLSpanElement>`に変更
- L16, L59-80: `<button>`→`<span>`に変更
  - 入れ子ボタンエラーを解決
  - `role="button"`, `tabIndex={0}`でアクセシビリティ維持
  - `e.stopPropagation()`で親ボタンのクリック防止
  - キーボード操作（Enter/Spaceキー）対応

**RenovationPanel.tsx のインポート修正**
- L4: `FACILITY_ADJUSTMENT_ITEMS`のインポート追加

---

## 🎯 動作確認方法

### 開発環境での確認手順

1. **開発サーバーを起動**
   ```bash
   npm run dev
   ```

2. **ブラウザで`http://localhost:5173`にアクセス**

3. **PINを入力してログイン**

4. **リノベーションモードを選択**

5. **「商業施設」タブが表示されることを確認**（開発環境のみ）

6. **画像をアップロード**

7. **施設タイプと元の空間を選択**
   - 施設タイプ: オフィス、ホテル、店舗、医療、教育、フィットネス、サロン、コワーキング
   - 元の空間: 倉庫、既存オフィス、元店舗、住宅、スケルトン

8. **コンセプトキーワードと規模を入力**

9. **「イメージ生成」ボタンをクリック**

10. **生成を繰り返してフェーズの自動進行を確認**
    - 1-3回目: 施設定義フェーズ
    - 4-6回目: ゾーニングフェーズ（エリア・動線設定が表示）
    - 7-9回目: 詳細デザインフェーズ（カラースキーム・素材設定が表示）
    - 10回目以降: 仕上げフェーズ（追加指示が表示）

---

## 📦 コミット履歴

```
0564777 - fix: 商業施設モードのエラー修正
1803422 - feat: 商業施設リノベーション機能の画像生成統合（Phase 1-4ワークフロー実装完了）
ab053a6 - feat: 商業施設リノベーション機能の基本UI実装（Phase 1-4）
```

---

## 🚀 今後のタスク（実装予定）

### 1. UI/UX改善

**優先度: 高**
- [ ] フェーズ進行のビジュアル表示（プログレスバー）
- [ ] 各フェーズの完了条件の明確化
- [ ] 生成履歴に商業施設モード専用のフィルター追加
- [ ] フェーズリセット機能（最初からやり直し）

**優先度: 中**
- [ ] プレビュー機能（現在の設定でどういうプロンプトになるか表示）
- [ ] 施設タイプ別のプリセット設定
- [ ] AIによるコンセプト提案機能
- [ ] 過去の商業施設プロジェクトの保存・読み込み

### 2. 機能拡張

**優先度: 高**
- [ ] 商業施設専用の見積もり生成機能
  - 用途変更に伴う法規制対応費用
  - 施設タイプ別の設備投資
  - 内装工事費用の詳細化

**優先度: 中**
- [ ] 施設タイプ別の調整項目の充実
  - オフィス: レイアウトパターン（島型、フリーアドレス等）
  - ホテル: 客室タイプ、共用部の設定
  - 店舗: 売り場面積、バックヤード比率
  - 医療: 診療科目別のレイアウト
- [ ] 複数パターンの並列生成機能
- [ ] 3Dビューへの変換（将来的な拡張）

### 3. データ管理

**優先度: 高**
- [ ] 商業施設プロジェクトのFirestore保存
- [ ] プロジェクト一覧・検索機能
- [ ] クライアント情報との紐付け

**優先度: 中**
- [ ] プロジェクトの共有機能
- [ ] エクスポート機能（PDF、画像セット）
- [ ] テンプレート機能（よく使う設定の保存）

### 4. AI機能の強化

**優先度: 高**
- [ ] フェーズ間の整合性チェック
  - 前フェーズの選択内容との矛盾検出
  - AIによる自動修正提案
- [ ] 生成画像の品質評価
  - 施設用途への適合度スコア
  - 改善提案

**優先度: 中**
- [ ] マルチモーダル入力対応
  - 参考画像の追加アップロード
  - スケッチからの生成
- [ ] インタラクティブな編集機能
  - 特定エリアの再生成
  - 部分的な修正

### 5. パフォーマンス最適化

**優先度: 中**
- [ ] 画像生成の並列処理
- [ ] プロンプトキャッシング
- [ ] 生成履歴のページネーション

### 6. ドキュメント整備

**優先度: 高**
- [ ] ユーザーガイドの作成
  - 各施設タイプの使い方
  - ベストプラクティス集
- [ ] 開発者向けドキュメント
  - アーキテクチャ図
  - データフロー図

**優先度: 中**
- [ ] チュートリアル動画の作成
- [ ] FAQの整備

### 7. テスト

**優先度: 高**
- [ ] 商業施設モードのE2Eテスト
- [ ] フェーズ切り替えのユニットテスト
- [ ] プロンプト生成ロジックのテスト

**優先度: 中**
- [ ] パフォーマンステスト
- [ ] アクセシビリティテスト

---

## 🔧 技術的な注意事項

### 開発時の注意点

1. **環境変数の確認**
   - 開発環境: `VITE_ENABLE_COMMERCIAL_MODE=true`
   - 本番環境: `VITE_ENABLE_COMMERCIAL_MODE=false`

2. **型の一貫性**
   - `CommercialRenovationContext`のフィールド追加時は、App.tsxの初期値も更新すること
   - `designDetails.themes`はMapだが、localStorageではシリアライズできないため注意

3. **プロンプト構築**
   - `promptHistory`は累積的に保存されるため、長くなりすぎないよう注意
   - 各フェーズで必要な情報のみを含めること

4. **フェーズ判定ロジック**
   - `generationCount`ベースで自動判定（App.tsx: L674-682）
   - RenovationPanel.tsxでも同じロジック（L2219-2225）
   - 2箇所のロジックを同期させること

### パフォーマンス考慮事項

1. **画像生成**
   - 商業施設モードは通常より複雑なプロンプトのため、生成時間が長くなる可能性
   - タイムアウト設定の見直しが必要かもしれない

2. **状態管理**
   - `commercialContext`はlocalStorageに保存されるため、サイズに注意
   - `promptHistory`が長くなりすぎる場合は、最新N件のみ保持するロジックを検討

### セキュリティ

1. **本番環境での無効化**
   - 必ず`.env.production`で`VITE_ENABLE_COMMERCIAL_MODE=false`を設定
   - デプロイ前にfeatureFlagsの値を確認

2. **データ保存**
   - 将来的にFirestoreに保存する際は、テナント分離を徹底
   - 商業施設プロジェクトは機密情報を含む可能性があるため、適切なアクセス制御を実装

---

## 📝 実装メモ

### 設計判断の記録

1. **なぜ4フェーズに分けたか**
   - 商業施設は住宅と異なり、用途・動線・法規制などの考慮事項が多い
   - 一度に全ての要素を指定するとユーザーが混乱する
   - 段階的に詳細化することで、より質の高い結果を得られる

2. **なぜgenerationCountで自動判定か**
   - ユーザーが明示的にフェーズを切り替える必要がない
   - 反復的な生成を推奨するUX
   - 各フェーズで複数回生成して最適解を探せる

3. **なぜlocalStorageで永続化か**
   - ページリロード時にも作業を継続できる
   - ネットワークエラー時のデータ損失を防ぐ
   - 将来的なFirestore統合の前段階として実装

---

## 🐛 既知の問題・制限事項

### 現在の制限

1. **ブラウザのlocalStorage容量**
   - promptHistoryが長くなると容量を圧迫する可能性
   - 現在は制限なしで保存しているため、将来的に最適化が必要

2. **Map型のシリアライゼーション**
   - `designDetails.themes`はMapだが、localStorageでは適切に保存されない
   - 現在は未使用のフィールドだが、使用する場合は対処が必要

3. **フェーズ間の戻り**
   - 一度進んだフェーズから前のフェーズに戻る機能がない
   - リセット機能の実装が必要

4. **生成失敗時の処理**
   - 生成が失敗してもgenerationCountは増加しない（意図的な設計）
   - ただし、ユーザーには失敗理由が不明瞭な場合がある

### 今後修正予定

- フェーズ進行のビジュアル表示
- promptHistoryのサイズ制限
- Map型フィールドの適切なシリアライゼーション
- エラーハンドリングの改善

---

## 📚 関連ドキュメント

- [types.ts](../types.ts) - 型定義（L328-422）
- [constants.ts](../constants.ts) - 定数定義（L699-991）
- [geminiService.ts](../services/geminiService.ts) - 画像生成エンジン（L815-992）
- [App.tsx](../App.tsx) - メインアプリケーション（L86-105, L640-691）
- [RenovationPanel.tsx](../components/RenovationPanel.tsx) - UI実装（L2213-2656）

---

**最終更新日**: 2025-10-04
**バージョン**: 1.0.0
**ステータス**: Phase 1-4 実装完了、動作確認済み
